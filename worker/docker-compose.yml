# Ingestion Worker Docker Compose (Standalone)
#
# This is an optional standalone compose file for running additional workers
# or for development/testing without the main stack.
#
# For production, the worker is included in the main docker-compose.yml
#
# Run with: docker-compose -f worker/docker-compose.yml up -d

services:
  # Redis (only needed for standalone deployment)
  redis:
    image: redis:7-alpine
    ports:
      - "6380:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5
    profiles:
      - standalone

  # Qdrant (only needed for standalone deployment)
  qdrant:
    image: qdrant/qdrant:latest
    ports:
      - "6335:6333"
    volumes:
      - qdrant_data:/qdrant/storage
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:6333/health" ]
      interval: 10s
      timeout: 5s
      retries: 5
    profiles:
      - standalone

  # Jaeger for tracing
  jaeger:
    image: jaegertracing/all-in-one:latest
    ports:
      - "16686:16686"
      - "4317:4317"
    environment:
      COLLECTOR_OTLP_ENABLED: "true"
    profiles:
      - observability

  # Ingestion Worker
  ingestion-worker:
    build:
      context: .
      dockerfile: worker/Dockerfile
    deploy:
      replicas: ${WORKER_REPLICAS:-2}
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 2G
    environment:
      SERVICE_NAME: ingestion-worker
      ENVIRONMENT: ${ENVIRONMENT:-development}

      # Redis - use main stack's Redis by default
      REDIS_HOST: ${REDIS_HOST:-redis}
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      REDIS_DB: ${REDIS_DB:-0}

      # Qdrant - use main stack's Qdrant by default
      QDRANT_HOST: ${QDRANT_HOST:-qdrant}
      QDRANT_PORT: ${QDRANT_PORT:-6333}
      QDRANT_API_KEY: ${QDRANT_API_KEY:-}

      # LLM/Embedding
      LLM_API_BASE: ${LLM_API_BASE:-http://host.docker.internal:4000/v1}
      LLM_API_KEY: ${LLM_API_KEY:-sk-dummy-key}
      EMBEDDING_API_BASE: ${EMBEDDING_API_BASE:-http://host.docker.internal:4000/v1}
      EMBEDDING_API_KEY: ${EMBEDDING_API_KEY:-sk-dummy-key}
      EMBEDDING_MODEL: ${EMBEDDING_MODEL:-text-embedding-3-small}
      EMBEDDING_DIMENSION: ${EMBEDDING_DIMENSION:-1536}

      # VLM
      VLM_API_BASE: ${VLM_API_BASE:-http://host.docker.internal:4000/v1}
      VLM_API_KEY: ${VLM_API_KEY:-sk-dummy-key}
      VLM_MODEL: ${VLM_MODEL:-llava-v1.6-34b}

      # Storage
      UPLOAD_DIR: /app/uploads
      TEMP_DIR: /app/temp

      # Worker config
      WORKER_CONCURRENCY: ${WORKER_CONCURRENCY:-5}
      JOB_TIMEOUT: ${JOB_TIMEOUT:-600}

      # Text splitting
      CHUNK_SIZE: ${CHUNK_SIZE:-1000}
      CHUNK_OVERLAP: ${CHUNK_OVERLAP:-200}

      # Telemetry
      OTEL_ENABLED: ${OTEL_ENABLED:-false}
      OTEL_EXPORTER_OTLP_ENDPOINT: ${OTEL_EXPORTER_OTLP_ENDPOINT:-http://jaeger:4317}
    volumes:
      - ${UPLOADS_VOLUME:-uploads_data}:/app/uploads
    extra_hosts:
      - "host.docker.internal:host-gateway"
    # For standalone mode, depend on local redis/qdrant
    # For connected mode (default), connects to main stack's services

networks:
  default:
    name: aladin_default
    external: true

volumes:
  redis_data:
  qdrant_data:
  uploads_data:
